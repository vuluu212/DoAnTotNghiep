<!doctype html>
<html lang="vi">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>EV Chart</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    html, body { height: 100%; margin: 0; }
    body { font-family: system-ui, -apple-system, Segoe UI, Roboto, sans-serif; }
    .wrap { height: 100%; padding: 10px; box-sizing: border-box; }
    canvas { width: 100% !important; height: 100% !important; }
  </style>
</head>
<body>
  <div class="wrap"><canvas id="chart"></canvas></div>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js";
  import { getDatabase, ref, get } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-database.js";

  // ✅ THAY firebaseConfig CỦA BẠN
  const firebaseConfig = {
    apiKey: "YOUR_API_KEY",
    authDomain: "YOUR_PROJECT.firebaseapp.com",
    databaseURL: "https://evchargi-default-rtdb.firebaseio.com",
    projectId: "YOUR_PROJECT_ID",
    storageBucket: "YOUR_PROJECT.appspot.com",
    messagingSenderId: "YOUR_SENDER_ID",
    appId: "YOUR_APP_ID",
  };

  const app = initializeApp(firebaseConfig);
  const db  = getDatabase(app);

  // --------- URL params ----------
  // ?id=USER_ID&type=topup|consumption
  const params = new URLSearchParams(window.location.search);
  const USER_ID = params.get("id") || params.get("uid") || "";
  const TYPE = (params.get("type") || "topup").toLowerCase();

  if (!USER_ID) {
    document.body.innerHTML =
      "<div style='padding:14px;font-family:system-ui'>Thiếu USER_ID. Dùng: <b>?id=USER_ID&type=topup</b> hoặc <b>&type=consumption</b></div>";
    throw new Error("Missing USER_ID");
  }

  // --------- Helpers ----------
  function parseKeyToDate(key) {
    // yyyy-MM-dd-hh-mm-ss
    const parts = key.split("-").map(x => parseInt(x, 10));
    if (parts.length !== 6 || parts.some(n => Number.isNaN(n))) return null;
    const [y, mo, d, h, mi, s] = parts;
    return new Date(y, mo - 1, d, h, mi, s);
  }

  function toNumber(val) {
    if (val === null || val === undefined) return 0;
    const s = String(val).replace(/"/g, "").trim();
    const n = Number(s);
    return Number.isFinite(n) ? n : 0;
  }

  function fmtLabel(dt) {
    const pad = (n) => String(n).padStart(2, "0");
    return `${pad(dt.getDate())}/${pad(dt.getMonth()+1)} ${pad(dt.getHours())}:${pad(dt.getMinutes())}:${pad(dt.getSeconds())}`;
  }

  // --------- Load data by type ----------
  function getPathByType(type) {
    if (type === "consumption") {
      return `EVCharging/Users/${USER_ID}/Charging/History_Electric_Consumption`;
    }
    // default topup
    return `EVCharging/Users/${USER_ID}/Wallet/History_topup`;
  }

  function getMetaByType(type) {
    if (type === "consumption") {
      return {
        title: "Tổng công suất tiêu thụ",
        yLabel: "Công suất tiêu thụ",
        unit: "W" // hoặc Wh/kWh tùy bạn đang lưu
      };
    }
    return {
      title: "Lịch sử nạp tiền",
      yLabel: "Tiền nạp",
      unit: "VND"
    };
  }

  async function loadRows(type) {
    const path = getPathByType(type);
    const snap = await get(ref(db, path));
    if (!snap.exists()) return [];

    const obj = snap.val(); // { "2025-...": 100, ... } hoặc "50000"
    const rows = Object.entries(obj).map(([k, v]) => {
      const dt = parseKeyToDate(k);
      return { key: k, date: dt, value: toNumber(v) };
    }).filter(r => r.date !== null);

    rows.sort((a, b) => a.date - b.date);
    return rows;
  }

  // --------- Chart ----------
  const meta = getMetaByType(TYPE);
  const chart = new Chart(document.getElementById("chart"), {
    type: "line",
    data: {
      labels: [],
      datasets: [{
        label: `${meta.yLabel} (${meta.unit})`,
        data: [],
        tension: 0.25,
        pointRadius: 3
      }]
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      plugins: {
        title: { display: true, text: meta.title },
        tooltip: {
          callbacks: {
            label: (ctx) => {
              const v = ctx.parsed.y;
              if (meta.unit === "VND") return ` ${v.toLocaleString("vi-VN")} VND`;
              return ` ${v.toLocaleString("vi-VN")} ${meta.unit}`;
            }
          }
        }
      },
      scales: {
        y: {
          ticks: {
            callback: (v) => meta.unit === "VND"
              ? Number(v).toLocaleString("vi-VN")
              : Number(v).toLocaleString("vi-VN")
          }
        }
      }
    }
  });

  let lastSig = "";

  function render(rows) {
    chart.data.labels = rows.map(r => fmtLabel(r.date));
    chart.data.datasets[0].data = rows.map(r => r.value);
    chart.update();
  }

  async function tick() {
    try {
      const rows = await loadRows(TYPE);
      const sig = JSON.stringify(rows.map(r => [r.key, r.value]));
      if (sig !== lastSig) {
        lastSig = sig;
        render(rows);
      }
    } catch (e) {
      console.error(e);
    }
  }

  // Auto refresh mỗi 2s
  tick();
  setInterval(tick, 2000);

</script>
</body>
</html>
