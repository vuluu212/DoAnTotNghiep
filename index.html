<!doctype html>
<html lang="vi">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>EV Chart</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <style>
    html, body { height: 100%; margin: 0; }
    body { font-family: system-ui, -apple-system, Segoe UI, Roboto, sans-serif; }

    .wrap { height: 100%; display: flex; flex-direction: column; }

    .bar {
      padding: 10px;
      display: flex;
      gap: 8px;
      border-bottom: 1px solid #e5e7eb;
    }

    .btn {
      padding: 8px 12px;
      border-radius: 10px;
      border: 1px solid #d1d5db;
      background: #fff;
      cursor: pointer;
      font-weight: 600;
    }

    .btn.active {
      background: #111827;
      color: #fff;
      border-color: #111827;
    }

    .canvas-wrap {
      flex: 1;
      padding: 10px;
      box-sizing: border-box;
      position: relative;
    }

    canvas {
      width: 100% !important;
      height: 100% !important;
    }

    .no-data {
      position: absolute;
      inset: 0;
      display: none;
      align-items: center;
      justify-content: center;
      background: #fff;
    }

    .no-data img {
      max-width: 60%;
      opacity: 0.9;
    }
  </style>
</head>

<body>
<div class="wrap">
  <div class="bar">
    <button class="btn" id="btnDay">Ngày</button>
    <button class="btn" id="btnWeek">Tuần</button>
    <button class="btn" id="btnMonth">Tháng</button>
  </div>

  <div class="canvas-wrap">
    <canvas id="chart"></canvas>
    <div class="no-data" id="noData">
      <img src="no_data.png" alt="No data">
    </div>
  </div>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js";
import { getDatabase, ref, get } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-database.js";

/* ================= Firebase ================= */
const firebaseConfig = {
  apiKey: "YOUR_API_KEY",
  authDomain: "YOUR_PROJECT.firebaseapp.com",
  databaseURL: "https://evchargi-default-rtdb.firebaseio.com",
  projectId: "YOUR_PROJECT_ID",
  appId: "YOUR_APP_ID",
};
const app = initializeApp(firebaseConfig);
const db  = getDatabase(app);

/* ================= URL ================= */
const params = new URLSearchParams(location.search);
const USER_ID = params.get("id");
const TYPE = (params.get("type") || "topup").toLowerCase();
if (!USER_ID) throw "Missing USER_ID";

/* ================= Helpers ================= */
const pad2 = n => String(n).padStart(2,"0");
const toNum = v => Number(String(v).replace(/"/g,"")) || 0;

function parseKey(k){
  const p = k.split("-").map(Number);
  if(p.length!==6) return null;
  return new Date(p[0],p[1]-1,p[2],p[3],p[4],p[5]);
}

function label(mode, d){
  const y = String(d.getFullYear()).slice(-2);
  if(mode==="day") return `${pad2(d.getDate())}/${pad2(d.getMonth()+1)}`;
  if(mode==="month") return `${pad2(d.getMonth()+1)}/${y}`;
  const w = Math.ceil((((d - new Date(d.getFullYear(),0,1))/86400000)+1)/7);
  return `W${pad2(w)}/${y}`;
}

function path(){
  return TYPE==="consumption"
    ? `EVCharging/Users/${USER_ID}/Charging/History_Electric_Consumption`
    : `EVCharging/Users/${USER_ID}/Wallet/History_topup`;
}

/* ================= Load ================= */
async function load(){
  const snap = await get(ref(db,path()));
  if(!snap.exists()) return [];
  return Object.entries(snap.val())
    .map(([k,v])=>{
      const d=parseKey(k); if(!d) return null;
      if(TYPE==="topup"){
        if(typeof v==="object")
          return {d, a:toNum(v.amount), b:toNum(v.balance_after)};
        return {d, a:toNum(v), b:null};
      }
      return {d, v:toNum(v)};
    }).filter(Boolean)
    .sort((a,b)=>a.d-b.d);
}

/* ================= Chart ================= */
const ctx=document.getElementById("chart");
const noData=document.getElementById("noData");

const chart=new Chart(ctx,{
  type:"line",
  data:{labels:[],datasets:[]},
  options:{
    responsive:true,
    maintainAspectRatio:false,
    plugins:{title:{display:false}},
    scales:{y:{ticks:{callback:v=>v.toLocaleString("vi-VN")}}}
  }
});

function showNoData(show){
  noData.style.display = show ? "flex":"none";
  ctx.style.display = show ? "none":"block";
}

/* ================= Group ================= */
function group(rows,mode){
  const m=new Map();
  for(const r of rows){
    const k=label(mode,r.d);
    if(!m.has(k)) m.set(k,{k,sum:0,last:r});
    m.get(k).sum += r.a ?? r.v;
    m.get(k).last = r;
  }
  return [...m.values()];
}

/* ================= Mode ================= */
let mode="day";
["Day","Week","Month"].forEach(t=>{
  document.getElementById("btn"+t).onclick=()=>{
    mode=t.toLowerCase(); draw(true);
    document.querySelectorAll(".btn").forEach(b=>b.classList.remove("active"));
    document.getElementById("btn"+t).classList.add("active");
  };
});
document.getElementById("btnDay").classList.add("active");

/* ================= Draw ================= */
async function draw(force=false){
  const rows=await load();

  // ✅ ĐIỀU KIỆN: cần >=2 giao dịch
  if(rows.length < 2){
    showNoData(true);
    chart.data.labels=[];
    chart.data.datasets=[];
    chart.update();
    return;
  }

  showNoData(false);

  const g=group(rows,mode);

  if(TYPE==="topup"){
    let run=0;
    chart.data.labels=g.map(x=>x.k);
    chart.data.datasets=[
      {
        label:"Tiền nạp (nghìn)",
        data:g.map(x=>x.sum/1000)
      },
      {
        label:"Số dư sau nạp (nghìn)",
        data:g.map(x=>{
          run+=x.sum;
          return (x.last.b??run)/1000;
        })
      }
    ];
  } else {
    chart.data.labels=g.map(x=>x.k);
    chart.data.datasets=[{
      label:"Tiêu thụ",
      data:g.map(x=>x.sum)
    }];
  }
  chart.update();
}

draw(true);
setInterval(draw,2000);
</script>
</body>
</html>
